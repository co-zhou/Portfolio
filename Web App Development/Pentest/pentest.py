from scapy.all import *
from time import sleep

if __name__ == '__main__':
    pkt = Ether(dst="ff:ff:ff:ff:ff:ff") / IP(src='0.0.0.0', dst="255.255.255.255") / UDP(sport=68, dport=67) / BOOTP(op=1)

    a = AsyncSniffer(iface="Ethernet",
                                 filter="port 68 and port 67")
    print("Starting asynchronous sniffer")
    a.start()
    sleep(1)
    sendp(pkt/DHCP(options=[("message-type", "discover"), "end"]))
    sleep(5)
    print("Stopping asynchronous sniffer")
    packet_list = a.stop()
    requested_ip = next((getattr(x["BOOTP"], "yiaddr") for x in packet_list if getattr(x["DHCP options"], "options")[[temp[0] for temp in getattr(x["DHCP options"], "options")].index("message-type")][1] == 2), None)

    if requested_ip:
        print("Requested IP:", requested_ip)

        for value in DHCPOptions.values():
            name = value
            if type(name) is not str:
                name = value.name
            print(name, type(value))
            sendp(pkt /
                    DHCP(options=[("message-type", "request"), ("requested_addr", requested_ip)]) /
                    DHCP(options=[(name, RawVal("!")), "end"]))
        
    else:
        print("No offer response")


